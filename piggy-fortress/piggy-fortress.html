<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="../phaser.min.js"></script>
        <script src="../Box2D_v2.3.1_min.js"></script>
        <!-- <script src="../box2d_util.min.js"></script> -->
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {


Box2D().then(function(Box2D) {
    
    var gravity = new Box2D.b2Vec2(0.0, 10);
    var world = new Box2D.b2World(gravity);
    var ground ;
    var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
    var cursors;
    var moving = 0;
    var background;
    var box;
    var boxes;
    var shape = new Box2D.b2PolygonShape();
    var shapeCircle = new Box2D.b2CircleShape();

    //var tell = 0;
    var height = 30;
    var width = 40;
    var x;
    var slingshot;
    var slingshot2;
    var tellCharacter = [0,0,0,0,0,0,0,0,0,0];
    //var bulletReadyState = false;
    var angle;
    var tellRight = 1;
    var vector;
    var time=0;
    var slingShotY= 1315;
    var whoTurn = "player";
    var start;
    var state = "regular" ;
    var lastFrameDown = false;
    var timeCount;
    var startScale=1;
    var timeArray = [0,0,0,0,0,0,0,0,0];
    var piggies;
    var piggy;
    var piggyIsThere = false;
    var needToKill = [];
    var invincible = false;
    var TIMEFORBUILDING = 2;
    var TIMEFORFIGHTING = 1000;
    var playerToDisplay = 0;
    var brickName = 1;
    var onTheSlingshot;
    var blocksLeft = [
        [
            20,
            20,
            20,
            20,
            5
        ],
        [
            20,
            20,
            20,
            20,
            5
        ],
    ];
    var BLOCK_TYPES = [
        {
            texture: 'box',
            height: 20,
            width:90,
            density: 5,
            brickName : 0,
            blocksLeft:20
        },
        {
            texture: 'box',
            height: 30,
            width: 40,
            density: 3,
            brickName : 1,
            blocksLeft:20
        },
        {
            texture: 'box',
            height: 80,
            width:30,
            density: 5,
            brickName : 2,
            blocksLeft:20
        },
        {
            texture: 'box',
            height: 15,
            width:200,
            density: 5,
            brickName : 3,
            blocksLeft:20
        },
    ]
    var blacks;
    var black;
    var icon;
    var leftNum = [];
    var tellFly = true;
    var CENTER_BORDER = 1100;
    var whoOnMyPointer;
    var whoOnMySlingshot1;
    var whoOnMySlingshot2;
    var tintTime = 0;
    var bloodOfBrick = 30;
    var lastFrameA;
    var lastFrameB;
    var covers;
    var cover;
    var coverText = [];
    var coverButton;
    var coverOff= false;
    var UI;
    var UIBlackground;
    var UISlingshot;
    var UIBrick = [];
    var UIPointer;
    var UIPointer2;
    var UITime = 0;
    var UITime3 = 0;
    var UITime5 = 0;
    var UIArrow = [];
    var UISlingshot2;
    var UISlingshot3;
   
    function resetAll(){
        
        for(var i = boxes.children.length-1;i>=0;--i){
            boxes.children[i].destroy();
        }
        
        for(var i = 0; i<2;i++){
            for(var j = 0; j<4;j++){
                blocksLeft[i][j]= 20 ; 
            }
            blocksLeft[i][4] = 5;
        }
        reround();

        for(var i = piggies.children.length-1;i>=0;--i){
            piggies.children[i].destroy();
        }
        
        for(var i=0;i<5;i++){
            piggy = piggies.create(620,slingShotY+i*20,'piggy');
            piggy.anchor.set(0.5);
            piggy.scale.set(0.1);
            x = new Box2D.b2Vec2(600/100, (slingShotY+i*20)/100);
            enableBox2D(piggy,true,x,"circle");
            piggy.movable = true;
            piggy.owner = 0;
        }
        for(var i=0;i<5;i++){
            piggy = piggies.create(1520,slingShotY+i*20,'piggy');
            piggy.anchor.set(0.5);
            piggy.scale.set(0.1);
            x = new Box2D.b2Vec2(1520/100, (slingShotY+i*20)/100);
            enableBox2D(piggy,true,x,"circle");
            piggy.movable = true;
            piggy.owner = 1;
        }

    }

    //var initialCameraX = game.camera.x;
    function reround(){
        game.camera.scale.x = 1;
        game.camera.scale.y = 1;
        game.camera.x = 0;
        game.camera.y = 1100;
        timeArray[0] = 0;
        timeArray[1] = 0;
        timeArray[2] = 0; 
        timeArray[3] = 0;
        whoTurn = "player";
        start.visible = true;
        start.scale.set(1);
        invincible = false;
        game.camera.y = 910;
    }
    
    function meterToPixel(meter){
        return meter*100;
    }

    function radianToDegree(radian){
        return radian/Math.PI*180;
    }
    
    function tellPointerCondition(){
        return game.input.activePointer.isDown && !lastFrameDown;
    }

    function tellPointerRightCondition(){
        if(!game.input.activePointer.isDown && tellRight === 0) {
            tellRight = 1;
            return true;
        }
        else if(game.input.activePointer.isDown){
            tellRight = 0;
            return false;
        }
        else if (!game.input.activePointer.isDown && tellRight === 1){
            return false;
        }
    }

    function tellCondition(character,number){
        if(game.input.keyboard.isDown(character) && tellCharacter[number] === 0) {
            tellCharacter[number] = 1;
            return true;
        }
        else if(!game.input.keyboard.isDown(character)){
            tellCharacter[number] = 0;
            return false;
        }
        else if (game.input.keyboard.isDown(character) && tellCharacter[number] === 1){
            return false;
        }
    }

    function ifOnTheSprite(x,y,sprite){
        if(Math.sqrt((x-sprite.x)*(x-sprite.x)+(y-sprite.y)*(y-sprite.y))<=(sprite.height/2)){
            //console.log(true);
            return true;
        }
        else{
            //console.log(false);
            return false;
        }
    }

    //function clamp(x, a, b){
    //
    //}

    function rgbToColor(r, g, b) {
        r = Math.round(r * 255);
        g = Math.round(g * 255);
        b = Math.round(b * 255);
        var rgb = b | (g << 8) | (r << 16);
        return rgb;
    }

    function actionOnClick(){
        covers.visible = false;
        //console.log("happened");
        //resetAll();
        coverOff = true;
    }

    //function actionOnClick2(sprite,pointer){
    //    covers.visible = false;
        //resetAll();
    //    coverOff = true;
    //}

    function preload() {
      this.load.image('background', 'assets/background.png');
      this.load.image('box', 'assets/box.png');
      this.load.image('sand', 'assets/sand.png');
      this.load.image('slingshot', 'assets/slingshots.png');
      this.load.image('piggy', 'assets/piggy.png');
      this.load.image('black', 'assets/black.png');
      this.load.image('coverPage', 'assets/desert.png');
      this.load.image('button', 'assets/button.png');
      this.load.image('blackground', 'assets/blackground.png');
      this.load.image('UIPointer', 'assets/UIpointer.png');
      this.load.image('UIArrow', 'assets/arrow.png');
    }

    function enableBox2D(sprite,movable,position,type) {

        var bd = new Box2D.b2BodyDef();
        if(movable){
            bd.set_type(Box2D.b2_dynamicBody);
        }
        bd.set_position(position);
        var body = world.CreateBody(bd);
        if (type ==="box"){
            shape.SetAsBox(sprite.width/200, sprite.height/200);
            var fixture_def = new Box2D.b2FixtureDef();
            fixture_def.set_shape(shape);
            fixture_def.set_density(10);
            fixture_def.set_friction(2);
            fixture_def.set_restitution(0.1);
    
        body.CreateFixture(fixture_def);
            body.CreateFixture(shape, 5.0);


            sprite.box2DBody = body;
        sprite.box2DBody.name = 'box';
        }
        if(type ==="circle"){
            shapeCircle.set_m_radius(sprite.height/200);

            body.CreateFixture(shapeCircle, 5.0);
            sprite.box2DBody = body;
            sprite.box2DBody.name = 'piggy';
        }

        sprite.box2DBody.sprite = sprite;
        sprite.r = 1 ;
        sprite.g = 1 ;
        sprite.b = 1 ;
        sprite.flashingSpeed = 0 ;
        sprite.deep = 0;
        

        
        sprite.update = function(){
            tintTime = tintTime+ game.time.physicsElapsed;
            sprite.x = meterToPixel(sprite.box2DBody.GetPosition().get_x());
            sprite.y = meterToPixel(sprite.box2DBody.GetPosition().get_y());
            sprite.angle = radianToDegree(sprite.box2DBody.GetAngle());
           // console.log(sprite.y);
           sprite.p = (Math.sin(sprite.flashingSpeed*tintTime)+1)/2*sprite.deep;
           sprite.tint = rgbToColor(sprite.r*(1-sprite.p)+1*sprite.p,sprite.g*(1-sprite.p),sprite.b*(1-sprite.p));

           if (sprite.y > 3000){
                sprite.destroy();
           }
            
        }
    
        sprite.setVelocity = function(x,y){
          var velocity = new Box2D.b2Vec2(x/100,y/100);
            sprite.box2DBody.SetLinearVelocity(velocity);
        }

        sprite.setPosition = function(x,y){
            var bulletPosition = new Box2D.b2Vec2(x/100, y/100); 
            sprite.box2DBody.SetTransform(bulletPosition, sprite.box2DBody.GetAngle());
        }
        sprite.getPositionX = function(){
            return meterToPixel(sprite.box2DBody.GetPosition().get_x());
        }
        
        sprite.getPositionY = function(){
            return meterToPixel(sprite.box2DBody.GetPosition().get_y());
        }

        function destroyBody() {
            world.DestroyBody(sprite.box2DBody);
            if (sprite.box2DBody.name === "piggy"){
                blocksLeft[sprite.owner][4]--;
               // console.log(blocksLeft[sprite.owner][4]);
            }
        }

        sprite.events.onDestroy.add(destroyBody, this);
        //call the function when the event happened
    }

    function create() {
        var listener = new Box2D.JSContactListener();
        listener.BeginContact = function (contactPtr) {
            var contact = Box2D.wrapPointer( contactPtr, Box2D.b2Contact );

            var fixtureA = contact.GetFixtureA();
            var fixtureB = contact.GetFixtureB();


            var velocityScalarB = Math.sqrt(fixtureB.GetBody().GetLinearVelocity().get_y()*fixtureB.GetBody().GetLinearVelocity().get_y()+fixtureB.GetBody().GetLinearVelocity().get_x()*fixtureB.GetBody().GetLinearVelocity().get_x());
            var velocityScalarA = Math.sqrt(fixtureA.GetBody().GetLinearVelocity().get_y()*fixtureA.GetBody().GetLinearVelocity().get_y()+fixtureA.GetBody().GetLinearVelocity().get_x()*fixtureA.GetBody().GetLinearVelocity().get_x());
            var power = (fixtureB.GetBody().GetMass())*0.5*velocityScalarB*velocityScalarB+(fixtureA.GetBody().GetMass())*0.5*velocityScalarA*velocityScalarA;
            //console.log(fixtureA.GetBody().name)
            if(power >= 10&&invincible){
                if(fixtureA.GetBody().name === "piggy"){
                    needToKill.push(fixtureA.GetBody().sprite);
                }
                if(fixtureB.GetBody().name === "piggy"){
                    
                    needToKill.push(fixtureB.GetBody().sprite);
                }

            }
            //fixtureA.GetBody().GetLinearVelocity().get_y()
            if(power>=100&&!(fixtureA===lastFrameA&&fixtureB===lastFrameB)){
               // console.log(fixtureA.GetBody().name, Math.random());
                if(fixtureA.GetBody().name != "piggy"&&fixtureA.GetBody().name != "ground"){
                    fixtureA.GetBody().sprite.flashingSpeed = fixtureA.GetBody().sprite.flashingSpeed+1;
                    fixtureA.GetBody().sprite.deep = fixtureA.GetBody().sprite.deep+ 1/bloodOfBrick;
                    if(fixtureA.GetBody().sprite.deep >= 1){
                        needToKill.push(fixtureA.GetBody().sprite);
                    }
                }

                if(fixtureB.GetBody().name != "piggy"&&fixtureB.GetBody().name != "ground"){
                    fixtureB.GetBody().sprite.flashingSpeed = fixtureB.GetBody().sprite.flashingSpeed+0.05;
                    fixtureB.GetBody().sprite.deep = fixtureB.GetBody().sprite.deep+ 0.5/bloodOfBrick;
                    if(fixtureB.GetBody().sprite.deep >= 1){
                        needToKill.push(fixtureB.GetBody().sprite);
                    }
                }
            }

            lastFrameA = fixtureA;
            lastFrameB = fixtureB;
        }

        listener.EndContact = function() {};
        listener.PreSolve = function() {};
        listener.PostSolve = function() {};

        world.SetContactListener( listener );

        world.SetAllowSleeping(false);
       
       
        game.world.setBounds(0, 0, 2280, 1700);
        game.camera.y = 1500;
        background = game.add.sprite(0, 0, 'background');

        cursors = game.input.keyboard.createCursorKeys();
        //game.input.onDown.add(toggle, this);
        background.height = game.world.height;
        background.width = game.world.width;
        
        ground = this.add.sprite(game.world.width/2,game.world.height,'sand');
        ground.anchor.set(0.5); 
        ground.width = game.world.width;
        ground.height = 600;
        var groundPosition = new Box2D.b2Vec2(game.world.width/200, (game.world.height)/100);
        enableBox2D(ground,false,groundPosition,"box");
        ground.box2DBody.name = "ground";
        slingshot = game.add.sprite(730,slingShotY,'slingshot');
        slingshot.anchor.set(0.5);
        slingshot.scale.set(0.9);
        slingshot2 = game.add.sprite(1430,slingShotY,'slingshot');
        slingshot2.anchor.set(0.5);
        slingshot2.scale.set(-0.9,0.9);
        blacks = game.add.group();
        
        blacks.fixedToCamera = true;
        for(var j = 38,i=0 ;i < 7;i++){
            black = blacks.create(j,525,'black');
            black.scale.set(0.2);
            black.anchor.set(0.5);
            black.alpha = 0.38;
            j = j+ black.width + 10;
        }
        for(var i =0 ; i<4; i++){
            icon = blacks.create(blacks.children[i].x,blacks.children[i].y,'box');
            icon.anchor.set(0.5);
            icon.height = BLOCK_TYPES[i].height*0.5;
            icon.width = BLOCK_TYPES[i].width*0.5;
        }
        boxes = game.add.group();
        start = game.add.text(100, 1100, 'Player1\nStart to build your fortress!',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '50px', fill: '#000' });
        timeCount = game.add.text(20, 20, 'time:  ',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '50px', fill: '#000' });
        timeCount.fixedToCamera = true
        piggies = game.add.group();
        game.camera.y = 910;
        for(var i=0;i<5;i++){
            piggy = piggies.create(620,slingShotY+i*20,'piggy');
            piggy.anchor.set(0.5);
            piggy.scale.set(0.1);
            x = new Box2D.b2Vec2(600/100, (slingShotY+i*20)/100);
            enableBox2D(piggy,true,x,"circle");
            piggy.movable = true;
            piggy.owner = 0;
        }
        for(var i=0;i<5;i++){
            piggy = piggies.create(1520,slingShotY+i*20,'piggy');
            piggy.anchor.set(0.5);
            piggy.scale.set(0.1);
            x = new Box2D.b2Vec2(1520/100, (slingShotY+i*20)/100);
            enableBox2D(piggy,true,x,"circle");
            piggy.movable = true;
            piggy.owner = 1;
        }
        leftNum[0] = game.add.text(blacks.children[0].x,blacks.children[0].y, '',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '40px', fill: '#000' }, blacks);
        leftNum[1] = game.add.text(blacks.children[1].x,blacks.children[1].y, '',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '40px', fill: '#000' }, blacks);
        leftNum[2] = game.add.text(blacks.children[2].x,blacks.children[2].y, '',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '40px', fill: '#000' }, blacks);
        leftNum[3] = game.add.text(blacks.children[3].x,blacks.children[3].y, '',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '40px', fill: '#000' }, blacks);

        leftNum[4] = game.add.text(blacks.children[4].x-20,blacks.children[4].y-20, 'Delete\nMode',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '20px', fill: '#000' }, blacks);
        leftNum[5] = game.add.text(blacks.children[5].x-20,blacks.children[5].y-20, 'Drag\nMode',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '20px', fill: '#000' }, blacks);
        
        
        covers = game.add.group();
        cover = covers.create(-100,900,'coverPage');
        cover.anchor.set(0);
        cover.width = 1100;
        cover.height = 630;
        coverText[0] = game.add.text(150,1000, 'Defense of\n',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '80px', fill: '#045' }, covers);
        coverText[1] = game.add.text(200,1100, 'Piggy',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '120px', fill: '#065' }, covers);
        coverText[1].angle = 5;
        
        //coverButton.inputEnabled = true;
        //coverButton.events.onInputDown.add(actionOnClick2,this);
        coverButton = covers.create(450, 1350, 'button');
        coverButton.scale.set(0.35,0.35);
        //coverButton.off = false;
        coverButton.anchor.set(0.5);

        UI = game.add.group();
        UIBlackground = UI.create(30, 50, 'blackground');
        UIBlackground.alpha = 0.38;
        UIBlackground.anchor.set(0);
        UIBlackground.width = game.world.width-100;
        UIBlackground.height = 350;
        UISlingshot = UI.create(430,UIBlackground.y+UIBlackground.height,'slingshot');
        UISlingshot.anchor.set(1);
        UIBrick[0] =UI.create(UISlingshot.x-400, UIBlackground.y+UIBlackground.height/2, 'box');
        UIPointer = UI.create(UISlingshot.x-420, UIBlackground.y+UIBlackground.height/2, 'UIPointer');
        UIPointer.scale.set(0.17);
        UIArrow[0] = UI.create(UISlingshot.x+300,UIPointer.y,'UIArrow');
        UIArrow[0].scale.set(0.5);
        UIArrow[0].anchor.set(0.5);
        UISlingshot2 = UI.create(UIArrow[0].x+300,UIBlackground.y+UIBlackground.height,'slingshot');
        UISlingshot2.anchor.set(1);
        UIBrick[1] = UI.create(UISlingshot2.x-100, UISlingshot2.y-230, 'box');
        UIArrow[1] = UI.create(UISlingshot2.x+300,UIPointer.y,'UIArrow');
        UIArrow[1].scale.set(0.5);
        UIArrow[1].anchor.set(0.5);
        UISlingshot3 = UI.create(UIArrow[1].x+300,UIBlackground.y+UIBlackground.height,'slingshot');
        UISlingshot3.anchor.set(1);
        UIBrick[2] = UI.create(UISlingshot3.x-100, UISlingshot3.y-230, 'box');
        UIPointer2 = UI.create(UIBrick[2].x - 20, UIBrick[2].y, 'UIPointer');
        UIPointer2.scale.set(0.17);
    }
    
    function toggle() {

        moving = (moving === 0) ? 1 : 0;

    }  
      
    function clock() {
        return Date.now();
    }

    function pointerWorldX(){
        return (game.input.activePointer.x+game.camera.x)/game.camera.scale.x;
    }
    
    function pointerWorldY(){
        return (game.input.activePointer.y+game.camera.y)/game.camera.scale.y;
    }

    function declineBrick(playerToDisplay,brickName){
     
            blocksLeft[playerToDisplay][brickName]--;
    }
//732,slingShotY-50
    function ifOnSlingshot(x,y,player){
        if(player === "player1"){
            if(Math.sqrt((x-732)*(x-732)+(y-slingShotY+50)*(y-slingShotY+50))<=40){
                return true;
            }
            else{
                return false;
            }
        }
//1410,slingShotY-50
        else if(player === "player2"){
            if(Math.sqrt((x-1410)*(x-1410)+(y-slingShotY+50)*(y-slingShotY+50))<=40){
                return true;
            }
            else{
                return false;
            }
        }
    }

    function toDisplay(playerToDisplay){
        leftNum[0].text = blocksLeft[playerToDisplay][0];
        leftNum[1].text = blocksLeft[playerToDisplay][1];
        leftNum[2].text = blocksLeft[playerToDisplay][2];
        leftNum[3].text = blocksLeft[playerToDisplay][3];
    }
    
function update() {
    //if (moving === 0)
    /*{
        if (cursors.up.isDown)
        {
            game.camera.y -= 4;
        }
        else if (cursors.down.isDown)
        {
            game.camera.y += 4;
        }

        if (cursors.left.isDown)
        {
            game.camera.x -= 4;
        }
        else if (cursors.right.isDown)
        {
            game.camera.x += 4;
        }
    }*/

    /*UISlingshot = UI.create(430,UIBlackground.y+UIBlackground.height,'slingshot');
        UISlingshot.anchor.set(1);
        UIBrick =UI.create(UISlingshot.x-40, UIBlackground.y+UIBlackground.height/2, 'box');
        UIPointer = UI.create(UISlingshot.x-60, UIBlackground.y+UIBlackground.height/2, 'UIPointer');
        UIPointer.scale.set(0.17);*/
    UITime = UITime + game.time.physicsElapsed;
    var UITime2 = UITime/4;
    if(UITime2<=1){
        var startX = UISlingshot.x-400;
        var startY = UIBlackground.y+UIBlackground.height/2;
        var endX = UISlingshot.x-UISlingshot.width/2-50;
        var endY =UISlingshot.y - 250;
        var bezierX = (startX + endX)/2 - 200;
        var bezierY = (startY + endY)/2 - 300;
        var x = (1 - UITime2)*(1 - UITime2)*startX + 2*(1-UITime2)*UITime2*bezierX+UITime2*UITime2*endX;
        var y = (1 - UITime2)*(1 - UITime2)*startY + 2*(1-UITime2)*UITime2*bezierY+UITime2*UITime2*endY;
        UIBrick[0].x = x;
        UIBrick[0].y = y;
        UIPointer.y = UIBrick[0].y;
        UIPointer.x = UIBrick[0].x -20;
    }
    else{
        UITime = 0;
    }

    UITime3 = UITime3 + game.time.physicsElapsed;
    var UITime4 = UITime3/2;
        
    if(UITime4<1){
        var startX2 = UISlingshot3.x-100;
        var startY2 = UISlingshot3.y-230;
        var endX2 = startX2 - 100;
        var endY2 = startY2 + 90;
        //var bezierX2 = (startX + endX)/2 - 200;
        //var bezierY2 = (startY + endY)/2 - 300;
        var x2 = startX2 + UITime3*(endX2 - startX2);
        var y2 =  startY2 + UITime3*(endY2 - startY2);
        UIBrick[2].x = x2;
        UIBrick[2].y = y2;
        UIPointer2.y = UIBrick[2].y;
        UIPointer2.x = UIBrick[2].x -20;
    }
    else{
        //console.log("1");
        UITime5 = UITime5 + game.time.physicsElapsed;
        if(UITime5<1){
            var startX3 = UISlingshot3.x-100- 100;
            var startY3 = UISlingshot3.y-230 + 90;
            var endX3 = startX3 + 600;
            var endY3 = startY3 - 100;
            var bezierX2 = (startX3 + endX3)/2 - 200;
            var bezierY2 = (startY3 + endY3)/2 - 200;
            var x3 = (1 - UITime5)*(1 - UITime5)*startX3 + 2*(1-UITime5)*UITime5*bezierX2+UITime5*UITime5*endX3;
            var y3 = (1 - UITime5)*(1 - UITime5)*startY3 + 2*(1-UITime5)*UITime5*bezierY2+UITime5*UITime5*endY3;
            UIBrick[2].x = x3;
            UIBrick[2].y = y3;
            //console.log("2");
        }
        else{
            UITime3 = 0;
            //console.log("3");
            UITime5 = 0;
        }
    }



    if(covers.visible === true){
        if(game.input.activePointer.isDown&&!lastFrameDown){
            //console.log(pointerWorldX());
            //console.log(coverButton.x+coverButton.width/2);
            //console.log(coverButton.x-coverButton.width/2);
            //console.log(pointerWorldY());
            //console.log(coverButton.height/2);
            if(pointerWorldX()<coverButton.x+coverButton.width/2&&pointerWorldX()>coverButton.x-coverButton.width/2&&pointerWorldY()>coverButton.y-coverButton.height/2&&
                pointerWorldY()<coverButton.y+coverButton.height/2){
                actionOnClick();
            actionOnClick();
            //console.log("hi");
            }
        }
    }

    if(!game.input.activePointer.isDown){
        world.Step(1.0/60.0, 3, 3);
    }
    
    if (ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[0])&&game.input.activePointer.isDown&&!lastFrameDown){
        height = BLOCK_TYPES[0].height;
        width = BLOCK_TYPES[0].width;
        piggyIsThere = false;
        state = "regular";
        brickName = BLOCK_TYPES[0].brickName;
     }
     if (ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[1])&&game.input.activePointer.isDown&&!lastFrameDown){
        height = BLOCK_TYPES[1].height;
        width = BLOCK_TYPES[1].width;
        piggyIsThere = false;
        state = "regular";
        brickName = BLOCK_TYPES[1].brickName;
     }
     if (ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[2])&&game.input.activePointer.isDown&&!lastFrameDown){
        height = BLOCK_TYPES[2].height;
        width = BLOCK_TYPES[2].width;
        piggyIsThere = false;
        state = "regular";
        brickName = BLOCK_TYPES[2].brickName;
     }
     if (ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[3])&&game.input.activePointer.isDown&&!lastFrameDown){
        height = BLOCK_TYPES[3].height;
        width = BLOCK_TYPES[3].width;
        piggyIsThere = false;
        state = "regular";
        brickName = BLOCK_TYPES[3].brickName;
     }
     
   
     if(blocksLeft[playerToDisplay][brickName]>0&&state === "regular"){
         //10,1595
         if(ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[0])||ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[1])||ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[2])||ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y, blacks.children[3])){
         if(tellPointerCondition()&&(!piggyIsThere)){
            box = boxes.create(pointerWorldX(),pointerWorldY(),'box');
            box.anchor.set(0.5);
            box.height = height;
            box.width = width;
            x = new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100);
            enableBox2D(box,true,x,"box");  
            box.name = brickName;
            box.movable = true;
            declineBrick(playerToDisplay,brickName);
            whoOnMyPointer = box;
         }

        /* if(tellPointerCondition()&&piggyIsThere){
            piggy = piggies.create(pointerWorldX(),pointerWorldY(),'piggy');
            piggy.anchor.set(0.5);
            piggy.scale.set(0.1);
            x = new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100);
            enableBox2D(piggy,true,x,"circle");
            piggy.movable = true;
            blocksLeft[playerToDisplay][4]--;

         }*/
        }
        
        }

        if(state === "regular"){
            if(box!== undefined){
            if(game.input.activePointer.isDown&&box.movable){
                //box.box2DBody.GetFixtureList().SetSensor(true);
               // box.x = pointerWorldX();
               // box.y = pointerWorldY();
                var follow = {x: pointerWorldX(), y:pointerWorldY()};
                if (whoTurn === "player1") {
                    follow.x = Math.min(follow.x, CENTER_BORDER);
                }
                else if (whoTurn === "player2") {
                    follow.x = Math.max(follow.x, CENTER_BORDER);   
                }
                box.setPosition(follow.x,follow.y);
                whoOnMyPointer = box;
                //console.log(box.y);
            }
            else{
                box.movable = false;
                //box.box2DBody.GetFixtureList().SetSensor(false);
            }
        if(!lastFrameDown&&game.input.activePointer.isDown){
            for(var i =0;i<boxes.children.length;++i){
                if(boxes.children[i].box2DBody.GetFixtureList().TestPoint(new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100)))
                {
                    //blocksLeft[playerToDisplay][boxes.children[i].name]++;
                    //boxes.children[i].destroy();
                    box = boxes.children[i];
                    box.movable = true;
                    whoOnMyPointer = box;
                }
            }
        }

       /* for(var i =0;i<boxes.children.length;++i){
                if(boxes.children[i].box2DBody.GetFixtureList().TestPoint(new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100))){
                    blocksLeft[playerToDisplay][boxes.children[i].name]++;
                    boxes.children[i].destroy();
                }
            }
        */
        }
        if(piggy!== undefined){
            if(game.input.activePointer.isDown&&piggy.movable){
                //box.box2DBody.GetFixtureList().SetSensor(true);
              //  piggy.x = pointerWorldX();
                //piggy.y = pointerWorldY();
                var follow = {x: pointerWorldX(), y:pointerWorldY()};
                if (whoTurn === "player1") {
                    follow.x = Math.min(follow.x, CENTER_BORDER);
                }
                else if (whoTurn === "player2") {
                    follow.x = Math.max(follow.x, CENTER_BORDER);   
                }

                piggy.setPosition(follow.x,follow.y);
            }
            else{
                piggy.movable = false;
                //box.box2DBody.GetFixtureList().SetSensor(false);
            }
        if(!lastFrameDown&&game.input.activePointer.isDown){
            for(var i =0;i<piggies.children.length;++i){
                if(piggies.children[i].box2DBody.GetFixtureList().TestPoint(new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100))){
                    //blocksLeft[playerToDisplay][boxes.children[i].name]++;
                    //boxes.children[i].destroy();
                    piggy = piggies.children[i];
                    piggy.movable = true;
                    whoOnMyPointer = piggy;
                }
            }
        }

       /* for(var i =0;i<boxes.children.length;++i){
                if(boxes.children[i].box2DBody.GetFixtureList().TestPoint(new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100))){
                    blocksLeft[playerToDisplay][boxes.children[i].name]++;
                    boxes.children[i].destroy();
                }
            }
        */
        }
    }

    
    time = time + game.time.physicsElapsed;
    //timeCount.text = 'time:'+Math.floor(time);
    if(time >= 2&&coverOff){
        if ( Math.floor(TIMEFORBUILDING-timeArray[0])>0){
            playerToDisplay = 0;
            if(startScale>0){
                start.scale.set(startScale);
                startScale= startScale - 0.05;
            }
            else{
                start.visible = false;
                if(Math.floor(TIMEFORBUILDING-timeArray[0])>0){
                    timeArray[0] +=  game.time.physicsElapsed;
                    timeCount.text = 'time:'+ Math.floor(TIMEFORBUILDING-timeArray[0]);
                    playerToDisplay = 0;
                }
            }
        }
        else if (Math.floor(TIMEFORBUILDING-timeArray[1])>0){

            if(game.camera.x < 1330){
                playerToDisplay = 0;
                game.camera.x = game.camera.x + 4;
                //start.visible = false;
            }
            else if(Math.floor(TIMEFORBUILDING-timeArray[1])>0){
                playerToDisplay = 1;

               // console.log(timeArray[1]);
                timeArray[1] +=  game.time.physicsElapsed;
                timeCount.text = 'time:'+ Math.floor(TIMEFORBUILDING-timeArray[1]);
                playerToDisplay = 1;
            }
        }
        else {
            playerToDisplay = 1;
            if(game.camera.scale.x > 0.35){
                game.camera.scale.x -= 0.003;
                game.camera.scale.y = game.camera.scale.x ;
               // console.log("x:"+game.camera.x);
            //console.log("y:"+game.camera.y);
            //console.log("xscale:"+game.camera.scale.x);
            //console.log("yscale:"+game.camera.scale.y);
                game.camera.y = game.camera.y + 20;
                //console.log(game.camera.y);
            }

            if(game.camera.x > 0){
                game.camera.x = game.camera.x - 5;
                //game.camera.y = game.camera.y + 20;
                //console.log(game.camera.x );
                
            }
            else if(Math.floor(TIMEFORFIGHTING-timeArray[2])>0){
                // console.log(whoTurn);
                playerToDisplay = 0;
                 whoTurn = "player1";
                 timeArray[2] +=  game.time.physicsElapsed;
                 timeCount.text = 'time:'+ Math.floor(TIMEFORFIGHTING-timeArray[2]);
                 //console.log(Math.floor(5-timeArray[2]));
                 invincible = true;
                 
            }
            else if(Math.floor(TIMEFORFIGHTING-timeArray[3])>0){
                playerToDisplay = 1;
                whoTurn = "player2";
                 timeArray[3] +=  game.time.physicsElapsed;
                 timeCount.text = 'time:'+ Math.floor(TIMEFORFIGHTING-timeArray[3]);
                 invincible = true;
                 
            }
            else{
                reround();

            }

        }
    }
    
    /*if(time >= 48 && time<=60){
        whoTurn = "player1";
        //console.log("player1"+whoTurn);
    }
    else if(time>72 ){
        whoTurn = "player2";
        //console.log("player2");
    }*/

    if(whoTurn === "player1"){
        if(lastFrameDown&&!game.input.activePointer.isDown&&ifOnSlingshot(pointerWorldX(),pointerWorldY(),"player1")){
                //box = boxes.create(732,slingShotY-50,'box');
                //box.anchor.set(0.5);
                //box.height = height;
                //box.width = width;
                //x = new Box2D.b2Vec2(732/100, slingShotY-50/100);
                //enableBox2D(box,true,x,"box");
                whoOnMyPointer.setPosition(732,slingShotY-50);
                state = "bulletReady";
                piggyIsThere = false;
            
         }

        if(state === "bulletReady"){
            whoOnMyPointer.setPosition(732,slingShotY-50);
            if(game.input.activePointer.isDown){
                var dest = {x: pointerWorldX(), y:pointerWorldY()};

                angle = Math.atan2(dest.y-slingShotY+50,dest.x-732);
                if(Math.sqrt((dest.x-732)*(dest.x-732)+(dest.y-slingShotY+50)*(dest.y-slingShotY+50))>(200/2)){
                    dest.x = 732 + (200/2) *Math.cos(angle);
                    dest.y = slingShotY-50 + (200/2) *Math.sin(angle);
                }

              whoOnMyPointer.setPosition(dest.x ,dest.y);


            }
             if(tellPointerRightCondition()){
               //x = new Box2D.b2Vec2(box.x/100, box.y/100);
                state = "regular";
                whoOnMyPointer.setVelocity(-(whoOnMyPointer.x-732)*20,-(whoOnMyPointer.y-slingShotY+50)*20);
                //console.log("hi");
            }
            
        }
    }
    else if(whoTurn ==="player2"){
        if(lastFrameDown&&!game.input.activePointer.isDown&&ifOnSlingshot(pointerWorldX(),pointerWorldY(),"player2")){
           
               // box = boxes.create(1410,slingShotY-50,'box');
               // box.anchor.set(0.5);
                //box.height = height;
                //box.width = width;
                //x = new Box2D.b2Vec2(1410/100, slingShotY-50/100);
                //enableBox2D(box,true,x,"box");
                whoOnMyPointer.setPosition(1410,slingShotY-50);
                state = "bulletReady";
                piggyIsThere = false;
         }

        if(state === "bulletReady"){
            whoOnMyPointer.setPosition(1410,slingShotY-50);
            if(game.input.activePointer.isDown){
                var dest = {x: pointerWorldX(), y:pointerWorldY()};

                angle = Math.atan2(dest.y-slingShotY+50,dest.x-1410);
                if(Math.sqrt((dest.x-1410)*(dest.x-1410)+(dest.y-slingShotY+50)*(dest.y-slingShotY+50))>(200/2)){
                    dest.x = 1410 + (200/2) *Math.cos(angle);
                    dest.y = slingShotY-50 + (200/2) *Math.sin(angle);
                }

                whoOnMyPointer.setPosition(dest.x ,dest.y);


            }
             if(tellPointerRightCondition()){
               //x = new Box2D.b2Vec2(box.x/100, box.y/100);
                state = "regular";
                whoOnMyPointer.setVelocity(-(whoOnMyPointer.x-1410)*20,-(whoOnMyPointer.y-slingShotY+50)*20);
                //console.log("hi");
            }
            
        }

    }
    if(ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y,blacks.children[4])&&game.input.activePointer.isDown&&!lastFrameDown){
        state = "delete";
    }

    if(state ==="delete"){
        if(tellPointerCondition()){
            for(var i =0;i<boxes.children.length;++i){
                if(boxes.children[i].box2DBody.GetFixtureList().TestPoint(new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100))) {
                    blocksLeft[playerToDisplay][boxes.children[i].name]++;
                    boxes.children[i].destroy();
                }
            }
        }
    }
    if(ifOnTheSprite(game.input.activePointer.x,game.input.activePointer.y,blacks.children[5])&&game.input.activePointer.isDown&&!lastFrameDown){
        state = "regular";
    }
    
    for(var i = 0 ;i<needToKill.length;i++){
        needToKill[i].destroy();
    }

    if(blocksLeft[0][4]===0 ||blocksLeft[1][4]===0){
        covers.visible = true;
        coverOff = false;
        resetAll();
    }
    
    needToKill = [];
    
    lastFrameDown = game.input.activePointer.isDown;

    blacks.scale.x = 1/game.camera.scale.x;
    blacks.scale.y = 1/game.camera.scale.y;
    toDisplay(playerToDisplay);

}



});

}

    

    </script>

    </body>
</html>