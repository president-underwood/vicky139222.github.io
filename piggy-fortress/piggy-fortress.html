<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="../phaser.min.js"></script>
        <script src="../Box2D_v2.3.1_min.js"></script>
        <!-- <script src="../box2d_util.min.js"></script> -->
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {


Box2D().then(function(Box2D) {
    
    var gravity = new Box2D.b2Vec2(0.0, 10);
    var world = new Box2D.b2World(gravity);
    var ground ;
    var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
    var cursors;
    var moving = 0;
    var background;
    var box;
    var boxes;
    var shape = new Box2D.b2PolygonShape();
    var shapeCircle = new Box2D.b2CircleShape();

    //var tell = 0;
    var height = 30;
    var width = 40;
    var x;
    var vX = 0;
    var vY = 0;
    var slingshot;
    var slingshot2;
    var tellCharacter = [0,0,0,0,0,0,0,0,0,0];
    //var bulletReadyState = false;
    var angle;
    var tellRight = 1;
    var vector;
    var time=0;
    var slingShotY= 1510;
    var whoTurn = "player";
    var start;
    var state = "regular" ;
    var lastFrameDown = false;
    var timeCount;
    var startScale=1;
    var timeArray = [0,0,0,0,0,0,0,0,0];
    var piggies;
    var piggy;
    var piggyIsThere = false;
    var needToKill = [];
    var invincible = false;
    var TIMEFORBUILDING = 20;
    var playerToDisplay = 0;
    var brickName = 1;
    var blocksLeft = [
        [
            10,
            10,
            10,
            10,
            5
        ],
        [
            10,
            10,
            10,
            10,
            5
        ],
    ];
    /*var BLOCK_TYPES = [
        {
            texture: 'box',
            width: 20,
            height: 20,
            density: 5,
        },
        {
            texture: 'box',
            width: 80,
            height: 20,
            density: 3,
        },
    ]*/

    

   


    //var initialCameraX = game.camera.x;

    function meterToPixel(meter){
        return meter*100;
    }

    function radianToDegree(radian){
        return radian/Math.PI*180;
    }
    
    function tellPointerCondition(){
        return game.input.activePointer.isDown && !lastFrameDown;
    }

    function tellPointerRightCondition(){
        if(!game.input.activePointer.isDown && tellRight === 0) {
            tellRight = 1;
            return true;
        }
        else if(game.input.activePointer.isDown){
            tellRight = 0;
            return false;
        }
        else if (!game.input.activePointer.isDown && tellRight === 1){
            return false;
        }
    }

    function tellCondition(character,number){
        if(game.input.keyboard.isDown(character) && tellCharacter[number] === 0) {
            tellCharacter[number] = 1;
            return true;
        }
        else if(!game.input.keyboard.isDown(character)){
            tellCharacter[number] = 0;
            return false;
        }
        else if (game.input.keyboard.isDown(character) && tellCharacter[number] === 1){
            return false;
        }
    }



    function preload() {
      this.load.image('background', 'assets/background.png');
      this.load.image('box', 'assets/box.png');
      this.load.image('sand', 'assets/sand.png');
      this.load.image('slingshot', 'assets/slingshots.png');
      this.load.image('piggy', 'assets/piggy.png');

    }

    function enableBox2D(sprite,movable,position,type) {

        var bd = new Box2D.b2BodyDef();
        if(movable){
            bd.set_type(Box2D.b2_dynamicBody);
        }
        bd.set_position(position);
        var body = world.CreateBody(bd);
        if (type ==="box"){
            shape.SetAsBox(sprite.width/200, sprite.height/200);

            body.CreateFixture(shape, 5.0);
            sprite.box2DBody = body;
        sprite.box2DBody.name = 'box';
        }
        if(type ==="circle"){
            shapeCircle.set_m_radius(sprite.height/200);

            body.CreateFixture(shapeCircle, 5.0);
            sprite.box2DBody = body;
        sprite.box2DBody.name = 'piggy';
        }

        sprite.box2DBody.sprite = sprite;
        
        sprite.update = function(){
            sprite.x = meterToPixel(sprite.box2DBody.GetPosition().get_x());
            sprite.y = meterToPixel(sprite.box2DBody.GetPosition().get_y());
            sprite.angle = radianToDegree(sprite.box2DBody.GetAngle());
           // console.log(sprite.y);
        }
    
        sprite.setVelocity = function(x,y){
          var velocity = new Box2D.b2Vec2(x/100,y/100);
            sprite.box2DBody.SetLinearVelocity(velocity);
        }

        sprite.setPosition = function(x,y){
            var bulletPosition = new Box2D.b2Vec2(x/100, y/100); 
            sprite.box2DBody.SetTransform(bulletPosition, sprite.box2DBody.GetAngle());
        }

        function destroyBody() {
            world.DestroyBody(sprite.box2DBody);
        }

        sprite.events.onDestroy.add(destroyBody, this);
    }

    function create() {
        var listener = new Box2D.JSContactListener();
        listener.BeginContact = function (contactPtr) {
            var contact = Box2D.wrapPointer( contactPtr, Box2D.b2Contact );
            var fixtureA = contact.GetFixtureA();
            var fixtureB = contact.GetFixtureB();
            var velocityScalarB = Math.sqrt(fixtureB.GetBody().GetLinearVelocity().get_y()*fixtureB.GetBody().GetLinearVelocity().get_y()+fixtureB.GetBody().GetLinearVelocity().get_x()*fixtureB.GetBody().GetLinearVelocity().get_x());
            var velocityScalarA = Math.sqrt(fixtureA.GetBody().GetLinearVelocity().get_y()*fixtureA.GetBody().GetLinearVelocity().get_y()+fixtureA.GetBody().GetLinearVelocity().get_x()*fixtureA.GetBody().GetLinearVelocity().get_x());
            var power = (fixtureB.GetBody().GetMass())*0.5*velocityScalarB*velocityScalarB+(fixtureA.GetBody().GetMass())*0.5*velocityScalarA*velocityScalarA;
            //console.log(fixtureA.GetBody().name)
            if(power >= 4&&invincible){
                if(fixtureA.GetBody().name === "piggy"){
                    needToKill.push(fixtureA.GetBody().sprite);
                }
                if(fixtureB.GetBody().name === "piggy"){
                    needToKill.push(fixtureB.GetBody().sprite);
                }

            }
            //fixtureA.GetBody().GetLinearVelocity().get_y()

        }

        listener.EndContact = function() {};
        listener.PreSolve = function() {};
        listener.PostSolve = function() {};

        world.SetContactListener( listener );

        world.SetAllowSleeping(false);
       
       
        game.world.setBounds(0, 0, 2500, 1700);
        game.camera.y = 1500;
        background = game.add.sprite(0, 0, 'background');

        cursors = game.input.keyboard.createCursorKeys();
        //game.input.onDown.add(toggle, this);
        background.height = game.world.height;
        background.width = game.world.width;
        
        ground = this.add.sprite(game.world.width/2,game.world.height,'sand');
        ground.anchor.set(0.5); 
        ground.width = game.world.width;
        ground.height = 220;
        var groundPosition = new Box2D.b2Vec2(game.world.width/200, (game.world.height)/100);
        enableBox2D(ground,false,groundPosition,"box");
        slingshot = game.add.sprite(730,slingShotY,'slingshot');
        slingshot.anchor.set(0.5);
        slingshot.scale.set(0.9);
        slingshot2 = game.add.sprite(1430,slingShotY,'slingshot');
        slingshot2.anchor.set(0.5);
        slingshot2.scale.set(-0.9,0.9);
        boxes = game.add.group();
        start = game.add.text(100, 1300, 'Player1\nStart to build your fortress!',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '50px', fill: '#000' });
        timeCount = game.add.text(20, 20, 'time: 20',{align:'left',boundsAlignH:'center',boundsAlignV:'middle',fontSize: '50px', fill: '#000' });
        timeCount.fixedToCamera = true;
        piggies = game.add.group();
    }
    
    function toggle() {

        moving = (moving === 0) ? 1 : 0;

    }  
      
    function clock() {
        return Date.now();
    }

    function pointerWorldX(){
        return game.input.activePointer.x/game.camera.scale.x+game.camera.x;
    }
    
    function pointerWorldY(){
        return game.input.activePointer.y/game.camera.scale.y+game.camera.y;
    }

    function declineBrick(playerToDisplay,brickName){
     
            blocksLeft[playerToDisplay][brickName]--;
        }
    
function update() {
    //if (moving === 0)
    /*{
        if (cursors.up.isDown)
        {
            game.camera.y -= 4;
        }
        else if (cursors.down.isDown)
        {
            game.camera.y += 4;
        }

        if (cursors.left.isDown)
        {
            game.camera.x -= 4;
        }
        else if (cursors.right.isDown)
        {
            game.camera.x += 4;
        }
    }*/

    world.Step(1.0/60.0, 3, 3);
     if (game.input.keyboard.isDown(Phaser.KeyCode.A)){
        height = 20;
        width = 90;
        piggyIsThere = false;
        state = "regular";
        brickName = 0;
     }
     if (game.input.keyboard.isDown(Phaser.KeyCode.S)){
        height = 30;
        width = 40;
        piggyIsThere = false;
        state = "regular";
        brickName = 1;
     }
     if (game.input.keyboard.isDown(Phaser.KeyCode.D)){
        height = 80;
        width = 30;
        piggyIsThere = false;
        state = "regular";
        brickName = 2;
     }
     if (game.input.keyboard.isDown(Phaser.KeyCode.W)){
        height = 15;
        width = 200;
        piggyIsThere = false;
        state = "regular";
        brickName = 3;
     }
     if (game.input.keyboard.isDown(Phaser.KeyCode.Z)){
        vX = 800;
        vY = -800;
        piggyIsThere = false;
        state = "regular";
     }
     if (game.input.keyboard.isDown(Phaser.KeyCode.X)){
        vX = 0;
        vY = 0;
        piggyIsThere = false;
        state = "regular";
     }
     if (game.input.keyboard.isDown(Phaser.KeyCode.P)){
        piggyIsThere = true;
        state = "regular";
        brickName = 4;
     }
   
     if(blocksLeft[playerToDisplay][brickName]>0&&state === "regular"){
         if(tellPointerCondition()&&(!piggyIsThere)){
            box = boxes.create(pointerWorldX(),pointerWorldY(),'box');
            box.anchor.set(0.5);
            box.height = height;
            box.width = width;
            x = new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100);
            enableBox2D(box,true,x,"box");  
            box.setVelocity(vX,vY);
            box.name = brickName;
            declineBrick(playerToDisplay,brickName);
         }

         if(tellPointerCondition()&&piggyIsThere){
            piggy = piggies.create(pointerWorldX(),pointerWorldY(),'piggy');
            piggy.anchor.set(0.5);
            piggy.scale.set(0.1);
            x = new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100);
            enableBox2D(piggy,true,x,"circle");
            piggy.setVelocity(vX,vY);
            blocksLeft[playerToDisplay][4]--;

         }
    }

    
    time = time + game.time.physicsElapsed;
    //timeCount.text = 'time:'+Math.floor(time);
    if(time >= 2){
        if ( Math.floor(TIMEFORBUILDING-timeArray[0])>0){
            if(startScale>0){
                start.scale.set(startScale);
                startScale= startScale - 0.05;
            }
            else{
                start.visible = false;
                if(Math.floor(TIMEFORBUILDING-timeArray[0])>0){
                    timeArray[0] +=  game.time.physicsElapsed;
                    timeCount.text = 'time:'+ Math.floor(TIMEFORBUILDING-timeArray[0]);
                    playerToDisplay = 0;
                }
            }
        }
        else if (Math.floor(TIMEFORBUILDING-timeArray[1])>0){
            
            if(game.camera.x < 1330){
                game.camera.x = game.camera.x + 4;
                //start.visible = false;
            }
            else if(Math.floor(TIMEFORBUILDING-timeArray[1])>0){
               // console.log(timeArray[1]);
                timeArray[1] +=  game.time.physicsElapsed;
                timeCount.text = 'time:'+ Math.floor(TIMEFORBUILDING-timeArray[1]);
                playerToDisplay = 1;
            }
        }
        else {
            
            if(game.camera.scale.x > 0.35){
                game.camera.scale.x -= 0.003;
                game.camera.scale.y = game.camera.scale.x ;
               // console.log("x:"+game.camera.x);
            //console.log("y:"+game.camera.y);
            //console.log("xscale:"+game.camera.scale.x);
            //console.log("yscale:"+game.camera.scale.y);
            }

            if(game.camera.x > 0){
                game.camera.x = game.camera.x - 5;
                //console.log(game.camera.x );
            }
            else if(Math.floor(10-timeArray[2])>0){
                // console.log(whoTurn);
                 whoTurn = "player1";
                 timeArray[2] +=  game.time.physicsElapsed;
                 timeCount.text = 'time:'+ Math.floor(10-timeArray[2]);
                 //console.log(Math.floor(5-timeArray[2]));
                 invincible = true;
                 
            }
            else if(Math.floor(10-timeArray[3])>0){
                whoTurn = "player2";
                 timeArray[3] +=  game.time.physicsElapsed;
                 timeCount.text = 'time:'+ Math.floor(10-timeArray[3]);
                 invincible = true;
                 
            }
            else{
                game.camera.scale.x = 1;
                game.camera.scale.y = 1;
                game.camera.x = 0;
                game.camera.y = 1100;
                timeArray[0] = 0;
                timeArray[1] = 0;
                timeArray[2] = 0; 
                timeArray[3] = 0;
                whoTurn = "player";
                start.visible = true;
                start.scale.set(1);
                invincible = false;

            }

        }
    }
    
    /*if(time >= 48 && time<=60){
        whoTurn = "player1";
        //console.log("player1"+whoTurn);
    }
    else if(time>72 ){
        whoTurn = "player2";
        //console.log("player2");
    }*/

    if(whoTurn === "player1"){
        if(tellCondition(Phaser.KeyCode.Q,0)){
           
                box = boxes.create(732,slingShotY-50,'box');
                box.anchor.set(0.5);
                box.height = height;
                box.width = width;
                x = new Box2D.b2Vec2(732/100, slingShotY-50/100);
                enableBox2D(box,true,x,"box");
                box.setVelocity(vX,vY);
                state = "bulletReady";
                piggyIsThere = false;
            
         }

        if(state === "bulletReady"){
            box.setPosition(732,slingShotY-50);
            if(game.input.activePointer.isDown){
                var dest = {x: pointerWorldX(), y:pointerWorldY()};

                angle = Math.atan2(dest.y-slingShotY+50,dest.x-732);
                if(Math.sqrt((dest.x-732)*(dest.x-732)+(dest.y-slingShotY+50)*(dest.y-slingShotY+50))>(200/2)){
                    dest.x = 732 + (200/2) *Math.cos(angle);
                    dest.y = slingShotY-50 + (200/2) *Math.sin(angle);
                }

                box.setPosition(dest.x ,dest.y);


            }
             if(tellPointerRightCondition()){
               //x = new Box2D.b2Vec2(box.x/100, box.y/100);
                state = "regular";
                box.setVelocity(-(box.x-732)*20,-(box.y-slingShotY+50)*20);
                //console.log("hi");
            }
            
        }
    }
    else if(whoTurn ==="player2"){
        if(tellCondition(Phaser.KeyCode.Q,0)){
           
                box = boxes.create(1410,slingShotY-50,'box');
                box.anchor.set(0.5);
                box.height = height;
                box.width = width;
                x = new Box2D.b2Vec2(1410/100, slingShotY-50/100);
                enableBox2D(box,true,x,"box");
                box.setVelocity(vX,vY);
                state = "bulletReady";
                piggyIsThere = false;
         }

        if(state === "bulletReady"){
            box.setPosition(1410,slingShotY-50);
            if(game.input.activePointer.isDown){
                var dest = {x: pointerWorldX(), y:pointerWorldY()};

                angle = Math.atan2(dest.y-slingShotY+50,dest.x-1410);
                if(Math.sqrt((dest.x-1410)*(dest.x-1410)+(dest.y-slingShotY+50)*(dest.y-slingShotY+50))>(200/2)){
                    dest.x = 1410 + (200/2) *Math.cos(angle);
                    dest.y = slingShotY-50 + (200/2) *Math.sin(angle);
                }

                box.setPosition(dest.x ,dest.y);


            }
             if(tellPointerRightCondition()){
               //x = new Box2D.b2Vec2(box.x/100, box.y/100);
                state = "regular";
                box.setVelocity(-(box.x-1410)*20,-(box.y-slingShotY+50)*20);
                //console.log("hi");
            }
            
        }

    }
    if(tellCondition(Phaser.KeyCode.C,1)){
        state = "delete";
    }

    if(state ==="delete"){
        if(tellPointerCondition()){
            for(var i =0;i<boxes.children.length;++i){
                if(boxes.children[i].box2DBody.GetFixtureList().TestPoint(new Box2D.b2Vec2(pointerWorldX()/100, pointerWorldY()/100))){
                    blocksLeft[playerToDisplay][boxes.children[i].name]++;
                    boxes.children[i].destroy();
                }
            }
        }
    }
    if(tellCondition(Phaser.KeyCode.R,2)){
        state = "regular";
    }
    
    for(var i = 0 ;i<needToKill.length;i++){
        needToKill[i].destroy();
    }
    needToKill = [];
    
    lastFrameDown = game.input.activePointer.isDown;


}



});

}

    

    </script>

    </body>
</html>